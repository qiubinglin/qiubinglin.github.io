---
layout:     post
title:      "NoC"
date:       2024-04-15 21:40:00
author:     "Bing"
catalog:    true
tags:
    - CPU
---

随着处理器核数量、缓存层级、I/O 模块增多，传统的总线（Bus）或交叉开关（Crossbar）互连方式遇到了严重瓶颈：
* 总线带宽有限 → 多核系统时严重冲突
* Crossbar 资源浪费 → 面积随节点数增长迅速

于是引入 NoC（Network on Chip），让核心之间的数据像“网络中通信”一样进行流动。显然这意味着更复杂而灵活的协议。

| 特性    | 总线    | Crossbar | NoC            |
| ----- | ----- | -------- | -------------- |
| 可扩展性  | 差     | 一般       | 好（可支持几十上百个核）   |
| 并发传输  | 差     | 一般       | 高（多通道同时传输）     |
| 面积与功耗 | 小（少核） | 增长快      | 面积功耗均衡         |
| 通信模型  | 广播    | 点对点      | 类似网络，基于 packet |

# NoC 的基本概念
|概念|含义|
|-|-|
|Node（节点）|通常是 CPU 核、缓存、内存控制器、DMA、I/O 等|
|Router（路由器）|每个节点连接的网络交换机，用于转发数据包|
|Link（链路）|Router 之间的物理通道（可以是单向/双向）|
|Flit（流单元）|Flow control unit：NoC 传输的最小单位（通常小于一个包）|
|Packet（包）|由多个 flit 组成的数据传输单元，携带地址、控制信息等|
|Topology（拓扑）|芯片内部的网络结构，例如 Mesh、Ring、Torus 等|
|Routing（路由算法）|决定包怎么从源头走到目的地（XY routing、adaptive 等）|
|Flow Control（流控）|控制数据流速、防止拥塞，如 credit-based、wormhole 等|

# NoC 在 CPU 中的位置
NoC 分布在 core、cache、memory controller、I/O 等模块之间，作为通信骨干网络。

```
+-------------------------------------------------------------+
|                          CPU Die                            |
|                                                             |
|  +---------+      +---------+      +---------+              |
|  |  Core 0 |<---->|  Core 1 |<---->|  Core 2 |<--+           |
|  +---------+      +---------+      +---------+   |          |
|       |                |                |        | Mesh or  |
|       v                v                v        | Ring     |
|  +--------+      +--------+      +--------+     | Topology |
|  |  L2$   |      |  L2$   |      |  L2$   |     <           |
|  +--------+      +--------+      +--------+     |           |
|       |                |                |        |          |
|       +--------->  NoC Routers <--------+        |          |
|                       ↓                         |          |
|             +-------------------+               |          |
|             | Shared L3 / LLC   | <--------------+          |
|             +-------------------+                          |
|             | Memory Controller | <--> DRAM                |
|             +-------------------+                          |
|             | I/O Units / PCIe  | <--> 外部设备             |
|             +-------------------+                          |
+-------------------------------------------------------------+
```

## NoC 管理的通信路径
| 通信路径                     | 示例                     |
| ------------------------ | ---------------------- |
| Core ↔ Core              | 多核间共享数据、任务同步           |
| Core ↔ L2 / L3 Cache     | 读取或写入共享数据              |
| Core ↔ Memory Controller | 访问主内存 DRAM             |
| Core ↔ I/O               | 与 PCIe、DMA 等外设通信       |
| Core ↔ Accelerator       | 如 GPU、TPU、NPU 等模块      |
| L2 ↔ L2                  | 多核间 L2 缓存 coherence 协议 |
| Cache ↔ Memory           | 缓存未命中时从 DRAM 请求数据      |
